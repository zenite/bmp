
var abpApp = {};

//多语言abpApp 资源
abpApp.L = function (key) {
    return abp.localization.getSource('Bpm')(key.firstLetterToUpper());
}

String.prototype.firstLetterToUpper = function () {
    return this.replace(/(\w)/, function (v) { return v.toUpperCase() });;
}
String.prototype.firstLetterToLower = function () {
    return this.replace(/(\w)/, function (v) { return v.toLowerCase() });;
}
var messageBox = null;
var phoneMessageBox = null;
var emailMessageBox = null;
var forgetMessageBox = null;

var Login = function () {
    var r1 = function () {
        //$(".login-form").validate({
        //    errorElement: "span",
        //    errorClass: "help-block",
        //    focusInvalid: !1,
        //    rules: {
        //        username: {
        //            required: !0
        //        },
        //        password: {
        //            required: !0
        //        },
        //        remember: {
        //            required: !1
        //        }
        //    },
        //    messages: {
        //        username: {
        //            required: "Username is required."
        //        },
        //        password: {
        //            required: "Password is required."
        //        }
        //    },
        //    invalidHandler: function (r, e) {
        //        $(".alert-danger", $(".login-form")).show()
        //    },
        //    highlight: function (r) {
        //        $(r).closest(".form-group").addClass("has-error")
        //    },
        //    success: function (r) {
        //        r.closest(".form-group").removeClass("has-error"),
        //        r.remove()
        //    },
        //    errorPlacement: function (r, e) {
        //        r.insertAfter(e.closest(".input-icon"))
        //    },
        //    submitHandler: function (r) {
        //        r.submit()
        //    }
        //}),
        $(".login-form input").keypress(function (r) {
            return 13 == r.which ? ($(".login-form").validate().form() && $(".login-form").submit(), !1) : void 0
        }),
        $(".forget-form input").keypress(function (r) {
            return 13 == r.which ? ($(".forget-form").validate().form() && $(".forget-form").submit(), !1) : void 0
        }),
        //显示忘记密码界面
        $("#forget-password").click(function () {
            $(".login-form,.register-form-email,.register-form-mobile").hide();
            $(".forget-form").show();
            $('#RegisterButton').html(abpApp.L("SignIn") + '<i class="m-icon-swapright m-icon-white"></i>');
            phoneMessageBox.hide();
            emailMessageBox.hide();
            forgetMessageBox.hide();
        }),
        //显示手机注册用户界面（登录界面注册先跳转到手机注册界面）
        $("#create-user,.form-title-mobile").click(function () {
            $(".login-form,.register-form-email,.login-form").hide();
            $(".register-form-mobile").show();
            messageBox.hide();
            emailMessageBox.hide();
            forgetMessageBox.hide();
        }),
        //显示邮箱注册用户界面
        $(".form-title-email").click(function () {
            $(".login-form,.register-form-mobile,.login-form").hide();
            $(".register-form-email").show();
            messageBox.hide();
            phoneMessageBox.hide();
            forgetMessageBox.hide();
        }),
        //返回按钮（显示登录页面）
        $(".btn-back").click(function () {
            $(".login-form").show();
            $(".forget-form,.register-form-email,.register-form-mobile").hide();
            $("#EmailAddressInput").focus();
            phoneMessageBox.hide();
            emailMessageBox.hide();
            forgetMessageBox.hide();
        }),
        $('#RegisterButtonPhone').click(function (e) {
            e.preventDefault();
            if (validation(1)) {
                abp.ui.setBusy(
                    $('.register-form'),
                    abp.ajax({
                        url: abp.appPath + 'api/services/app/sys/RegisterUser',
                        type: 'POST',
                        data: JSON.stringify({
                            PhoneNumber: $('#phone').val().replace(/\s+/g, ""),
                            Password: $('#regpassword').val(),
                            Code: $('#regcode').val(),
                        })
                    }).done(function (data) {
                        if (!data.isSuccess) {
                            phoneMessageBox.children("span").text(data.message);
                            phoneMessageBox.show();
                        } else {
                            abp.ui.setBusy(
                            $('.login-form'),
                            abp.ajax({
                                url: abp.appPath + 'Account/Login',
                                type: 'POST',
                                data: JSON.stringify({
                                    usernameOrEmailAddress: $('#phone').val().replace(/\s+/g, ""),
                                    password: $('#regpassword').val(),
                                })
                            }).done(function (data) {
                                if (!!data) {
                                    phoneMessageBox.children("span").text(data);
                                    phoneMessageBox.show();
                                }
                            })
                        );
                        }

                    })
                );
            }
        }),
        $('#RegisterButtonEmail').click(function (e) {
            e.preventDefault();
            if (validation(2)) {
                abp.ui.setBusy(
                    $('.register-form-email'),
                    abp.ajax({
                        url: abp.appPath + 'api/services/app/sys/ResetAutoLoginEmail',
                        type: 'POST',
                        data: JSON.stringify({
                            EmailNumber: $('#email').val().replace(/\s+/g, ""),
                            Password: $('#regpasswordEmail').val(),
                            //Code: $('#regcodeEmail').val(),
                        })
                    }).done(function (data) {
                        if (!data.isSuccess) {
                            emailMessageBox.children("span").text(data.message);
                            emailMessageBox.show();
                        } else {
                            abp.message.success(abpApp.L('ActivateMailbox'));
                        }

                        //abp.ui.setBusy(
                        //    $('.login-form'),
                        //    abp.ajax({
                        //        url: abp.appPath + 'Account/Login',
                        //        type: 'POST',
                        //        data: JSON.stringify({
                        //            usernameOrEmailAddress: $('#email').val().replace(/\s+/g, ""),
                        //            password: $('#regpasswordEmail').val(),
                        //        })
                        //    }).done(function (data) {
                        //        if (!!data) {
                        //            messageBox.children("span").text(data);
                        //            messageBox.show();
                        //        }
                        //    })
                        //);

                    })
                );
            }
        }),
        $('#ForgetButton').click(function (e) {
            e.preventDefault();
            if (validation(3)) {
                abp.ui.setBusy(
                    $('.register-form'),
                    abp.ajax({
                        url: abp.appPath + 'api/services/app/sys/ResetPassword',
                        type: 'POST',
                        data: JSON.stringify({
                            PhoneNumber: $('#phoneForget').val().replace(/\s+/g, ""),
                            Password: $('#passwordForget').val(),
                            Code: $('#regcodeForget').val(),
                        })
                    }).done(function (data) {
                        if (!data.isSuccess) {
                            forgetMessageBox.children("span").text(data.message);
                            forgetMessageBox.show();
                        } else {
                            abp.message.success(abpApp.L("ResetSuccessfullyPleaseLogin")); //重置密码成功,请登录
                        }
                        //abp.ui.setBusy(
                        //    $('.login-form'),
                        //    abp.ajax({
                        //        url: abp.appPath + 'Account/Login',
                        //        type: 'POST',
                        //        data: JSON.stringify({
                        //            usernameOrEmailAddress: $('#phoneForget').val().replace(/\s+/g, ""),
                        //            password: $('#passwordForget').val(),
                        //        })
                        //    }).done(function (data) {
                        //        if (!!data) {
                        //            messageBox.children("span").text(data);
                        //            messageBox.show();
                        //        }
                        //    })
                        //);

                    })
                );
            }
        }),
        $("input").keydown(function (event) {
            if (event.which == "13") {
                if ($(".login-form").is(":visible")) {
                    $("#LoginButton").click();
                } else if ($(".register-form").is(":visible")) {
                    $("#RegisterButton").click();
                }
            }
        })
    };
    return {
        init: function () {
            r1();
            $(".login-bg").backstretch(["../Content/Images/bg1.jpg", "../Content/Images/bg1.jpg"], {
                fade: 1e3,
                duration: 8e3
            });
            $(".forget-form,.register-form").hide();

            var reg = new RegExp("(^|&)" + "type" + "=([^&]*)(&|$)");
            var r = window.location.search.substr(1).match(reg);
            if (r != null) {
                $(".forget-form,.register-form-mobile,.login-form,.register-form-email").hide();
                switch (unescape(r[2])) {
                    case "0":
                        $(".login-form").show();
                        break;
                    case "1":
                        $(".register-form-mobile").show();
                        break;
                    case "2":
                        $(".register-form-email").show();
                        break;
                    case "3":
                        $(".forget-form").show();
                        break;
                    default:
                        break;
                }
            }

            messageBox = $(".MessageBox");
            phoneMessageBox = $(".PhoneMessageBox");
            emailMessageBox = $(".EmailMessageBox");
            forgetMessageBox = $(".ForgetMessageBox");


            $('#LoginButton').click(function (e) {
                e.preventDefault();
                abp.ui.setBusy(
                    $('.login-form'),
                    abp.ajax({
                        url: abp.appPath + 'Account/Login',
                        type: 'POST',
                        data: JSON.stringify({
                            //tenancyName: $('#TenancyName').val(),
                            usernameOrEmailAddress: $('#EmailAddressInput').val(),
                            password: $('#PasswordInput').val(),
                            rememberMe: $('#RememberMeInput').is(':checked')
                        })
                    }).done(function (data) {
                        if (!!data) {
                            messageBox.children("span").text(data);
                            messageBox.show();
                        }
                    })
                );
            });
            $("#EmailAddressInput").focus();
        }
    }
}();
jQuery(document).ready(function () {
    Login.init();
});


var validation = function (type) {//type 1：手机注册 2：邮箱注册 3：忘记密码
    var box = null;
    if (type == 1) {
        box = phoneMessageBox;
    }
    else if (type == 2) {
        box = emailMessageBox;
    }
    else if (type == 3) {
        box = forgetMessageBox;
    }

    var numbers = /^1\d{10}$/;
    var emailReg = /\w+([-+.]\w+)*@\w+([-.]\w+)*\.\w+([-.]\w+)*/;
    var phone = "";
    var password = "";
    var passwordConfirm = "";
    var code = "";
    var tnc = "";

    if (type == 1) {
        phone = $('#phone').val().replace(/\s+/g, "");
        password = $('#regpassword').val();
        code = $('#regcode').val();
        tnc = $('#tncP').is(':checked');
        passwordConfirm = $('#passwordconfirm').val();

        if (!numbers.test(phone) || phone.length == 0) {
            box.children("span").text(abpApp.L("PhoneNumberError"));
            box.show();
            return false;
        }

        if (code.length == 0) {
            box.children("span").text(abpApp.L("CodeRequired"));
            box.show();
            return false;
        }
       
    }
    if (type == 2) {
        email = $('#email').val().replace(/\s+/g, "");
        password = $('#regpasswordEmail').val();
        code = $('#regcodeEmail').val();
        tnc = $('#tncE').is(':checked');
        passwordConfirm = $('#passwordconfirmEmail').val();
        if (!emailReg.test(email) || email.length == 0) {
            box.children("span").text(abpApp.L("EmailAddressError"));
            box.show();
            return false;
        }
        if (email.length > 32) {
            box.children("span").text(abpApp.L("UserNameTooLong"));
            box.show();
            return false;
        }
    }

    if (type == 3) {
        phone = $('#phoneForget').val().replace(/\s+/g, "");
        password = $('#passwordForget').val();
        code = $('#regcodeForget').val();
        passwordConfirm = $('#passwordConfirm').val();
        tnc = $('#tncF').is(':checked');

        if (!numbers.test(phone) || phone.length == 0) {
            box.children("span").text(abpApp.L("PhoneNumberError"));
            box.show();
            return false;
        }

        if (code.length == 0) {
            box.children("span").text(abpApp.L("CodeRequired"));
            box.show();
            return false;
        }
    }


    if (password.length == 0 || passwordConfirm.length == 0) {
        box.children("span").text(abpApp.L("PasswrodRequired"));
        box.show();
        return false;
    }

    if (password != passwordConfirm) {
        box.children("span").text(abpApp.L("TwoPasswordNotSame"));
        box.show();
        return false;
    }
   
    if (!tnc) {
        box.children("span").text(abpApp.L("AcceptTncErr"));
        box.show();
        return false;
    }

    return true;
}

var sends = {
    checked: 1,
    send: function () {
        var numbers = /^1\d{10}$/;
        var phone = $('.register-form-mobile #phone').val().replace(/\s+/g, "");

        if ($('.div-phone').find('span').length == 0 && $('.div-phone a').attr('class') == 'send1') {
            if (!numbers.test(phone) || phone.length == 0) {
                phoneMessageBox.children("span").text("Phone");
                phoneMessageBox.show();
                return false;
            }
        }

        if (numbers.test(phone)) {
            var time = 60;
            $('.div-phone span').remove();

            function timeCountDown() {
                if (time == 0) {
                    clearInterval(timer);
                    $('.div-phone a').addClass('send1').removeClass('send0').html(abpApp.L("SendVerificationCode"));
                    $(".div-phone a").attr("onclick", "sends.send();");
                    sends.checked = 1;
                    return true;
                }
                $('.div-phone a').html(time + abpApp.L("SendCodeAgain"));
                $('.div-phone a').removeAttr('onclick');

                time--;
                return false;
                sends.checked = 0;
            }

            $('.div-phone a').addClass('send0').removeClass('send1');
            timeCountDown();
            var timer = setInterval(timeCountDown, 1000);

            abp.ui.setBusy(
                $('.register-form'),
                abp.ajax({
                    url: abp.appPath + 'api/services/app/sys/ResetAutoLoginPhone',
                    type: 'POST',
                    data: JSON.stringify({
                        PhoneNumber: $('#phone').val().replace(/\s+/g, ""),
                    })
                }).done(function (data) {
                    //var time = 60;
                    //$('.div-phone span').remove();

                    //function timeCountDown() {
                    //    if (time == 0) {
                    //        clearInterval(timer);
                    //        $('.div-phone a').addClass('send1').removeClass('send0').html(abpApp.L("SendVerificationCode"));
                    //        $(".div-phone a").attr("onclick", "sends.send();");
                    //        sends.checked = 1;
                    //        return true;
                    //    }
                    //    $('.div-phone a').html(time + abpApp.L("SendCodeAgain"));
                    //    $('.div-phone a').removeAttr('onclick');

                    //    time--;
                    //    return false;
                    //    sends.checked = 0;
                    //}

                    //$('.div-phone a').addClass('send0').removeClass('send1');
                    //timeCountDown();
                    //var timer = setInterval(timeCountDown, 1000);
                })
            );
        }
    },
    sendEmail: function () {
        var numbers = /\w+([-+.]\w+)*@\w+([-.]\w+)*\.\w+([-.]\w+)*/;
        var email = $('.register-form-email #email').val().replace(/\s+/g, "");

        if ($('.div-email').find('span').length == 0 && $('.div-email a').attr('class') == 'send1') {
            if (!numbers.test(email) || email.length == 0) {
                emailMessageBox.children("span").text(abpApp.L("EmailAddressError"));
                emailMessageBox.show();
                return false;
            }
        }

        if (numbers.test(email)) {
            var time = 60;
            $('.div-email span').remove();

            function timeCountDown() {
                if (time == 0) {
                    clearInterval(timer);
                    $('.div-email a').addClass('send1').removeClass('send0').html(abpApp.L("SendVerificationCode"));
                    $(".div-email a").attr("onclick", "sends.sendEmail();");
                    sends.checked = 1;
                    return true;
                }
                $('.div-email a').html(time + abpApp.L("SendCodeAgain"));
                $('.div-email a').removeAttr('onclick');

                time--;
                return false;
                sends.checked = 0;
            }

            $('.div-email a').addClass('send0').removeClass('send1');
            timeCountDown();
            var timer = setInterval(timeCountDown, 1000);

            abp.ui.setBusy(
                $('.register-form'),
                abp.ajax({
                    url: abp.appPath + 'api/services/app/sys/ResetValidationCode',
                    type: 'POST',
                    data: JSON.stringify({
                        EmailNumber: $('#email').val().replace(/\s+/g, ""),
                    })
                }).done(function (data) {
                })
            );
        }
    },
    ShowError: function(str){
        forgetMessageBox.show();
        forgetMessageBox.children("span").text(abpApp.L("UserRequired"));
        return false;
    },
    sendForget: function () {
        var numbers = /^1\d{10}$/;
        var mailaddress = new RegExp(/^([a-zA-Z0-9_\.\-])+\@(([a-zA-Z0-9\-])+\.)+([a-zA-Z0-9]{2,4})+$/);
        var phone = $('.forget-form #phoneForget').val().replace(/\s+/g, "");
        debugger;
        if ($('.forget').find('span').length == 0 && $('.forget a').attr('class') == 'send1') {
            if (phone.length == 0) {
                return sends.ShowError(abpApp.L("UserRequired"));
            } else if (!numbers.test(phone)) {
                if (!mailaddress.test(phone)) {
                    return sends.ShowError(abpApp.L("UserRequired"));
                }
            }
            forgetMessageBox.hide();
        }

        if (numbers.test(phone)) {
            var time = 60;
            $('.forget span').remove();

            function timeCountDown() {
                if (time == 0) {
                    clearInterval(timer);
                    $('.forget a').addClass('send1').removeClass('send0').html(abpApp.L("SendVerificationCode"));
                    $(".forget a").attr("onclick", "sends.sendForget();");
                    $('.forget input').css({ width: "calc(100% - 90px)" });
                    $('.forget a').css({ width: "80px" });
                    sends.checked = 1;
                    return true;
                }
                $('.forget a').html(time + abpApp.L("SendCodeAgain"));
                $('.forget a').removeAttr('onclick');
                $('.forget input').css({ width: "calc(100% - 110px)" });
                $('.forget a').css({ width: "100px", fontFamily: "'Microsoft YaHei'" });
                time--;
                return false;
                sends.checked = 0;
            }

            $('.forget a').addClass('send0').removeClass('send1');
            timeCountDown();
            var timer = setInterval(timeCountDown, 1000);
            abp.ui.setBusy(
                $('.forget-form'),
                abp.ajax({
                    url: abp.appPath + 'api/services/app/sys/ResetValidationCode',
                    type: 'POST',
                    data: JSON.stringify({
                        PhoneNumber: $('#phoneForget').val().replace(/\\s+/g, ""),
                    })
                }).done(function (data) {

                })
            );
        } else if (mailaddress.test(phone)) {
            var time = 60;
            $('.forget span').remove();
            function timeCountDown() {
                if (time == 0) {
                    clearInterval(timer);
                    $('.forget a').addClass('send1').removeClass('send0').html(abpApp.L("SendVerificationCode"));
                    $(".forget a").attr("onclick", "sends.sendForget();");
                    $('.forget input').css({ width: "calc(100% - 90px)" });
                    $('.forget a').css({ width: "80px" });
                    sends.checked = 1;
                    return true;
                }
                $('.forget a').html(time + abpApp.L("SendCodeAgain"));
                $('.forget a').removeAttr('onclick');
                $('.forget input').css({ width: "calc(100% - 110px)" });
                $('.forget a').css({ width: "100px", fontFamily: "'Microsoft YaHei'" });
                time--;
                return false;
                sends.checked = 0;
            }

            $('.forget a').addClass('send0').removeClass('send1');
            timeCountDown();
            var timer = setInterval(timeCountDown, 1000);
            abp.ui.setBusy(
                $('.forget-form'),
                abp.ajax({
                    url: abp.appPath + 'api/services/app/sys/ResetValidationCode',
                    type: 'POST',
                    data: JSON.stringify({
                        EmailNumber: $('#phoneForget').val().replace(/\\s+/g, ""),
                    })
                }).done(function (data) {

                })
            );
        }
    }
}